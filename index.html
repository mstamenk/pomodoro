<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pomodoro Focus</title>
  <meta name="description" content="Lightweight Pomodoro timer with tasks and stats. All local & private.">
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"/>
  <!-- Replace with your real public URL if different -->
  <link rel="canonical" href="https://mstamenk.github.io/pomodoro/"/>
  <!-- Open Graph -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Pomodoro Focus"/>
  <meta property="og:description" content="Lightweight Pomodoro timer with tasks and stats. All local & private."/>
  <meta property="og:url" content="https://mstamenk.github.io/pomodoro/"/>
  <!-- Optional: provide a real absolute URL to an image in your repo -->
  <!-- <meta property="og:image" content="https://mstamenk.github.io/pomodoro/og-image.png"/> -->
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="Pomodoro Focus"/>
  <meta name="twitter:description" content="Lightweight Pomodoro timer with tasks and stats. All local & private."/>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23ef4444'/%3E%3Ctext x='32' y='40' font-size='28' text-anchor='middle' fill='white' font-family='Arial, Helvetica, sans-serif'%3E25%3C/text%3E%3C/svg%3E"/>
  <style>
    html, body { height: 100%; }
    .tick-through { text-decoration: line-through; opacity: 0.7; }
    .dragging { opacity: 0.4; }
  </style>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Pomodoro Focus",
    "applicationCategory": "ProductivityApplication",
    "operatingSystem": "Web",
    "url": "https://mstamenk.github.io/pomodoro/",
    "description": "Lightweight Pomodoro timer with tasks and stats. All local & private.",
    "offers": {"@type": "Offer", "price": "0", "priceCurrency": "USD"}
  }
  </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between gap-3">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Pomodoro Focus</h1>
      <div class="flex items-center gap-2">
        <button id="exportBtn" class="px-3 py-1.5 rounded-xl bg-slate-800 text-white text-sm">Export</button>
        <label class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-800 text-sm cursor-pointer">
          Import
          <input id="importInput" type="file" accept="application/json" class="hidden" />
        </label>
        <button id="settingsBtn" class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-800 text-sm">Settings</button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
      <!-- Left: Timer & Stats -->
      <section class="space-y-6">
        <!-- Session Tabs -->
        <div class="flex gap-2">
          <button data-mode="focus" class="modeTab px-3 py-2 rounded-2xl bg-red-500 text-white text-sm font-semibold">Focus</button>
          <button data-mode="short" class="modeTab px-3 py-2 rounded-2xl bg-slate-200 text-slate-800 text-sm font-semibold">Short Break</button>
          <button data-mode="long" class="modeTab px-3 py-2 rounded-2xl bg-slate-200 text-slate-800 text-sm font-semibold">Long Break</button>
        </div>

        <!-- Timer Card -->
        <div class="bg-white rounded-3xl shadow p-6 md:p-8">
          <div class="text-center">
            <div class="mx-auto relative w-56 h-56">
    <svg class="block mx-auto" width="224" height="224" viewBox="0 0 220 220" aria-hidden="true">
      <circle cx="110" cy="110" r="96" stroke="#E2E8F0" stroke-width="16" fill="none"></circle>
      <circle id="progressRing" cx="110" cy="110" r="96" stroke="#ef4444" stroke-width="16" fill="none" stroke-linecap="round" transform="rotate(-90 110 110)"></circle>
    </svg>
    <div class="absolute inset-0 flex items-center justify-center">
      <div id="timerDisplay" class="text-6xl md:text-7xl font-mono tabular-nums tracking-tight">25:00</div>
    </div>
  </div>
            <div class="mt-2 text-sm text-slate-500" id="cycleInfo">Cycle 0 • Next long break in 4</div>
            <div class="mt-4 flex items-center justify-center gap-3">
              <button id="startPauseBtn" class="px-5 py-2.5 rounded-2xl bg-slate-800 text-white font-semibold">Start</button>
              <button id="resetBtn" class="px-4 py-2 rounded-2xl bg-slate-200">Reset</button>
              <button id="skipBtn" class="px-4 py-2 rounded-2xl bg-slate-200">Skip →</button>
            </div>
            
          </div>
        </div>

        <!-- Today Summary -->
        <div class="bg-white rounded-3xl shadow p-6">
          <h2 class="font-semibold mb-4">Today</h2>
          <div class="grid grid-cols-3 gap-4 text-center">
            <div class="p-4 rounded-2xl bg-slate-50">
              <div class="text-3xl font-bold" id="todayMinutes">0</div>
              <div class="text-xs text-slate-500">Focus minutes</div>
            </div>
            <div class="p-4 rounded-2xl bg-slate-50">
              <div class="text-3xl font-bold" id="todaySessions">0</div>
              <div class="text-xs text-slate-500">Sessions</div>
            </div>
            <div class="p-4 rounded-2xl bg-slate-50">
              <div class="text-3xl font-bold" id="streakDays">0</div>
              <div class="text-xs text-slate-500">Day streak</div>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div class="bg-white rounded-3xl shadow p-6">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">Last 14 days</h2>
            <span class="text-xs text-slate-500">Sessions per day</span>
          </div>
          <canvas id="statsChart" height="140"></canvas>
        </div>
      </section>

      <!-- Right: Tasks -->
      <section class="space-y-4">
        <div class="bg-white rounded-3xl shadow p-6">
          <h2 class="font-semibold mb-4">Tasks</h2>
          <form id="taskForm" class="flex gap-2 mb-4">
            <input id="taskInput" type="text" placeholder="Add a task and hit Enter" class="flex-1 rounded-2xl border border-slate-200 px-3 py-2">
            <input id="estInput" type="number" min="0" step="1" placeholder="Est. poms" class="w-28 rounded-2xl border border-slate-200 px-3 py-2">
            <button class="px-4 py-2 rounded-2xl bg-slate-800 text-white">Add</button>
          </form>
          <ul id="tasksList" class="space-y-2"></ul>
          <div class="mt-4 flex items-center justify-between text-sm">
            <button id="clearDoneBtn" class="px-3 py-1.5 rounded-xl bg-slate-200">Clear completed</button>
            <label class="flex items-center gap-2">
              <input id="autoAdvanceTask" type="checkbox" class="rounded"> <span>Auto-assign pomodoros to selected task</span>
            </label>
          </div>
        </div>

        <div class="bg-white rounded-3xl shadow p-6">
          <h2 class="font-semibold mb-2">Tips</h2>
          <ul class="list-disc ml-5 text-sm text-slate-600 space-y-1">
            <li>Click the circle to complete a task. Drag the handle to reorder.</li>
            <li>Click the flag to set the <em>current</em> task; finished focus sessions will add to it.</li>
            <li>Everything is saved locally in your browser (no accounts, no servers).</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <!-- Settings Modal -->
  <dialog id="settingsDialog" class="rounded-3xl w-full max-w-md p-0">
    <form method="dialog" class="bg-white rounded-3xl p-6">
      <h3 class="text-lg font-semibold mb-4">Settings</h3>
      <div class="grid grid-cols-2 gap-3">
        <label class="text-sm">Focus (min)
          <input id="setFocus" type="number" min="1" class="w-full mt-1 rounded-xl border border-slate-200 px-3 py-2">
        </label>
        <label class="text-sm">Short break (min)
          <input id="setShort" type="number" min="1" class="w-full mt-1 rounded-xl border border-slate-200 px-3 py-2">
        </label>
        <label class="text-sm">Long break (min)
          <input id="setLong" type="number" min="1" class="w-full mt-1 rounded-xl border border-slate-200 px-3 py-2">
        </label>
        <label class="text-sm">Long break every
          <input id="setEvery" type="number" min="2" class="w-full mt-1 rounded-xl border border-slate-200 px-3 py-2">
        </label>
        <label class="text-sm col-span-2 flex items-center gap-2 mt-2">
          <input id="setAutoStart" type="checkbox" class="rounded"> Auto-start next session
        </label>
        <label class="text-sm col-span-2 flex items-center gap-2">
          <input id="setSound" type="checkbox" class="rounded" checked> Sound at session end
        </label>
        <label class="text-sm col-span-2 flex items-center gap-2">
          <input id="setNotify" type="checkbox" class="rounded"> Desktop notification at session end
        </label>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button id="resetAllBtn" type="button" class="px-3 py-1.5 rounded-xl bg-red-100 text-red-700">Reset all data</button>
        <button class="px-3 py-1.5 rounded-xl bg-slate-800 text-white">Close</button>
      </div>
    </form>
  </dialog>

  <!-- Tiny chime (base64 wav) -->
  <audio id="chime" preload="auto" src="data:audio/wav;base64,UklGRpQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHG1hZGEAAAAAAAAAAAAA/////wAA//8AAP//AAD///8AAP//AAD///8AAP//AAD///8AAP//AAD///8AAAAA"></audio>

  <script>
  // ---------- Utilities ----------
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
  const todayKey = () => new Date().toISOString().slice(0,10);

  function clamp(n, mi, ma){ return Math.max(mi, Math.min(ma, n)); }

  // ---------- State ----------
  const DEFAULTS = {
    focusMin: 25,
    shortMin: 5,
    longMin: 15,
    longEvery: 4,
    autoStartNext: false,
    sound: true,
    notify: false,
  };

  let state = {
    mode: 'focus', // 'focus' | 'short' | 'long'
    remainingMs: DEFAULTS.focusMin * 60 * 1000,
    sessionTotalMs: DEFAULTS.focusMin * 60 * 1000,
    running: false,
    endAt: null,
    cyclesCompleted: 0,
    tasks: [], // {id, text, done, est, poms, current}
    prefs: {...DEFAULTS},
    stats: {
      // 'YYYY-MM-DD': { minutes: 0, sessions: 0 }
    }
  };

  // ---------- Persistence ----------
  const STORE_KEY = 'pomodoro_focus_v1';
  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return;
      const saved = JSON.parse(raw);
      state = {
        ...state,
        ...saved,
        prefs: { ...DEFAULTS, ...(saved.prefs||{}) },
      };
      // Safety: coerce missing fields
      state.tasks = (state.tasks||[]).map(t => ({poms:0, est:0, done:false, current:false, ...t}));
      // Migrate stats to new shape (minutes + per-mode counts)
      const stats = state.stats || {};
      Object.keys(stats).forEach(k => {
        const v = stats[k] || {};
        stats[k] = {
          minutes: typeof v.minutes === 'number' ? v.minutes : 0,
          focus: typeof v.focus === 'number' ? v.focus : (typeof v.sessions === 'number' ? v.sessions : 0),
          short: typeof v.short === 'number' ? v.short : 0,
          long: typeof v.long === 'number' ? v.long : 0,
        };
      });
      state.stats = stats;
    }catch(e){ console.warn('Load failed', e); }
  }) },
      };
      // Safety: coerce missing fields
      state.tasks = (state.tasks||[]).map(t => ({poms:0, est:0, done:false, current:false, ...t}));
    }catch(e){ console.warn('Load failed', e); }
  }
  function save(){
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
  }

  load();

  // ---------- Timer Logic ----------
  const timerDisplay = $('#timerDisplay');
  const cycleInfo = $('#cycleInfo');
  const startPauseBtn = $('#startPauseBtn');
  const resetBtn = $('#resetBtn');
  const skipBtn = $('#skipBtn');
  const chime = $('#chime');
  const progressRing = document.getElementById('progressRing');
  function updateRing(){
    if(!progressRing) return;
    const r = progressRing.r.baseVal.value;
    const c = 2 * Math.PI * r;
    progressRing.style.strokeDasharray = c;
    const fracRemaining = state.sessionTotalMs > 0 ? Math.max(0, Math.min(1, state.remainingMs / state.sessionTotalMs)) : 1;
    progressRing.style.strokeDashoffset = c * (1 - fracRemaining); // full at start, empties to 0
    // Color by mode
    progressRing.style.stroke = (state.mode === 'focus') ? '#ef4444' : (state.mode === 'short' ? '#3b82f6' : '#10b981');
  }

  function durationFor(mode){
    const p = state.prefs;
    return (mode==='focus'?p.focusMin:mode==='short'?p.shortMin:p.longMin) * 60 * 1000;
  }

  function setMode(mode){
    state.mode = mode;
    state.sessionTotalMs = durationFor(mode);
    state.remainingMs = state.sessionTotalMs;
    state.running = false;
    state.endAt = null;
    updateModeTabs();
    renderTimer();
    save();
  }

  function updateModeTabs(){
    $$('.modeTab').forEach(btn => {
      if(btn.dataset.mode === state.mode){
        btn.className = 'modeTab px-3 py-2 rounded-2xl bg-red-500 text-white text-sm font-semibold';
      } else {
        btn.className = 'modeTab px-3 py-2 rounded-2xl bg-slate-200 text-slate-800 text-sm font-semibold';
      }
    });
    const toLong = state.prefs.longEvery - (state.cyclesCompleted % state.prefs.longEvery);
    cycleInfo.textContent = `Cycle ${state.cyclesCompleted} • Next long break in ${toLong}`;
  }

  function format(ms){
    const s = Math.max(0, Math.round(ms/1000));
    const m = Math.floor(s/60);
    const ss = s%60;
    return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  }

  function renderTimer(){
    timerDisplay.textContent = format(state.remainingMs);
    startPauseBtn.textContent = state.running ? 'Pause' : 'Start';
    updateRing();
  }

  function tick(){
    if(!state.running) return;
    const now = Date.now();
    state.remainingMs = Math.max(0, state.endAt - now);
    renderTimer();
    if(state.remainingMs <= 0){
      onSessionComplete();
    }
  }

  function start(){
    if(state.running) return;
    state.running = true;
    state.endAt = Date.now() + state.remainingMs;
    renderTimer();
  }
  function pause(){
    if(!state.running) return;
    state.running = false;
    state.remainingMs = Math.max(0, state.endAt - Date.now());
    state.endAt = null;
    renderTimer();
  }
  function reset(){
    state.running = false;
    state.endAt = null;
    state.sessionTotalMs = durationFor(state.mode);
    state.remainingMs = state.sessionTotalMs;
    renderTimer();
  }

  function notifyUser(title, body){
    try{
      if(state.prefs.sound){ chime.currentTime = 0; chime.play().catch(()=>{}); }
      if(state.prefs.notify && 'Notification' in window){
        if(Notification.permission === 'granted'){
          new Notification(title, { body });
        } else if(Notification.permission !== 'denied'){
          Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(title,{body}); });
        }
      }
    }catch(e){ /* noop */ }
  }

  function onSessionComplete(){
    pause();
    const k = todayKey();
    state.stats[k] = state.stats[k] || { minutes: 0, focus: 0, short: 0, long: 0 };

    if(state.mode === 'focus'){
      state.stats[k].minutes += Math.round(durationFor('focus')/60000);
      state.stats[k].focus += 1;
      state.cyclesCompleted += 1;
      // Assign to current task if enabled
      if($('#autoAdvanceTask').checked){
        const t = state.tasks.find(t=>t.current);
        if(t){ t.poms = (t.poms||0) + 1; if(t.est && t.poms >= t.est) t.done = true; }
      }
    } else if(state.mode === 'short') {
      state.stats[k].short += 1;
    } else {
      state.stats[k].long += 1;
    }

    // Next mode
    let nextMode = 'focus';
    if(state.mode === 'focus'){
      nextMode = (state.cyclesCompleted % state.prefs.longEvery === 0) ? 'long' : 'short';
    } else {
      nextMode = 'focus';
    }
    setMode(nextMode);
    updateTodaySummary();
    renderTasks();
    renderChart();
    save();

    notifyUser('Session complete', `Time for ${state.mode === 'focus' ? 'focus' : state.mode} ✨`);

    if(state.prefs.autoStartNext){ start(); }
  };
      state.stats[k].minutes += Math.round(durationFor('focus')/60000);
      state.stats[k].sessions += 1;
      state.cyclesCompleted += 1;
      // Assign to current task if enabled
      if($('#autoAdvanceTask').checked){
        const t = state.tasks.find(t=>t.current);
        if(t){ t.poms = (t.poms||0) + 1; if(t.est && t.poms >= t.est) t.done = true; }
      }
    }

    // Next mode
    let nextMode = 'focus';
    if(state.mode === 'focus'){
      nextMode = (state.cyclesCompleted % state.prefs.longEvery === 0) ? 'long' : 'short';
    } else {
      nextMode = 'focus';
    }
    setMode(nextMode);
    updateTodaySummary();
    renderTasks();
    renderChart();
    save();

    notifyUser('Session complete', `Time for ${state.mode === 'focus' ? 'focus' : state.mode} ✨`);

    if(state.prefs.autoStartNext){ start(); }
  }

  // ---------- Tasks ----------
  const taskForm = $('#taskForm');
  const taskInput = $('#taskInput');
  const estInput = $('#estInput');
  const tasksList = $('#tasksList');

  function addTask(text, est=0){
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random());
    state.tasks.push({ id, text: text.trim(), done:false, est: Number(est)||0, poms:0, current: state.tasks.length===0 });
    save();
    renderTasks();
  }

  function renderTasks(){
    tasksList.innerHTML = '';
    state.tasks.forEach(task => {
      const li = document.createElement('li');
      li.className = 'group p-3 rounded-2xl border border-slate-200 hover:shadow bg-white overflow-hidden';
      li.draggable = true;
      li.dataset.id = task.id;

      // Row 1: main line
      const row1 = document.createElement('div');
      row1.className = 'flex items-center gap-3 flex-wrap';

      const drag = document.createElement('button');
      drag.className = 'cursor-grab text-slate-400 hover:text-slate-600 shrink-0';
      drag.innerHTML = '⋮⋮';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = task.done;
      checkbox.className = 'w-5 h-5 rounded shrink-0';
      checkbox.addEventListener('change', () => { task.done = checkbox.checked; save(); renderTasks(); });

      const txt = document.createElement('input');
      txt.type = 'text';
      txt.value = task.text;
      txt.className = 'flex-1 min-w-[10rem] bg-transparent focus:outline-none break-words';
      txt.addEventListener('input', () => { task.text = txt.value; save(); });
      if(task.done) txt.classList.add('tick-through');

      const currentBtn = document.createElement('button');
      currentBtn.className = `px-2 py-1 rounded-xl shrink-0 ${task.current? 'bg-amber-100 text-amber-800':'bg-slate-100 text-slate-600'}`;
      currentBtn.textContent = task.current ? '● current' : '○ current';
      currentBtn.title = 'Mark as current task';
      currentBtn.addEventListener('click', () => {
        state.tasks.forEach(t=>t.current=false);
        task.current = true; save(); renderTasks();
      });

      const del = document.createElement('button');
      del.className = 'px-2 py-1 rounded-xl text-red-600 hover:bg-red-50 shrink-0';
      del.textContent = 'Delete';
      del.addEventListener('click', () => {
        state.tasks = state.tasks.filter(t=>t.id!==task.id);
        if(!state.tasks.some(t=>t.current) && state.tasks[0]) state.tasks[0].current = true;
        save(); renderTasks();
      });

      row1.append(drag, checkbox, txt, currentBtn, del);

      // Row 2: metadata
      const row2 = document.createElement('div');
      row2.className = 'mt-2 w-full flex items-center gap-2 text-xs text-slate-500 flex-wrap';
      const estLabel = document.createElement('span'); estLabel.textContent = 'Est:';
      const est = document.createElement('input');
      est.type = 'number'; est.min = '0'; est.step = '1'; est.value = task.est||0;
      est.className='w-16 rounded-lg border border-slate-200 px-2 py-1';
      est.title = 'Estimated pomodoros';
      est.addEventListener('change', () => { task.est = Number(est.value)||0; save(); renderTasks(); });

      const badge = document.createElement('span');
      badge.className = 'px-2 py-0.5 rounded-full bg-slate-100';
      badge.textContent = `${task.poms||0} / ${task.est||0}`;

      row2.append(estLabel, est, badge);

      li.append(row1, row2);
      tasksList.append(li);

      // Drag & drop
      li.addEventListener('dragstart', e=>{ li.classList.add('dragging'); e.dataTransfer.setData('text/plain', task.id); });
      li.addEventListener('dragend', ()=> li.classList.remove('dragging'));
    });

    tasksList.addEventListener('dragover', e=>{
      e.preventDefault();
      const afterEl = getDragAfterElement(tasksList, e.clientY);
      const dragging = document.querySelector('.dragging');
      if(!dragging) return;
      if(afterEl == null){ tasksList.appendChild(dragging); }
      else { tasksList.insertBefore(dragging, afterEl); }
    });

    tasksList.addEventListener('drop', ()=>{
      // Recompute order
      const ids = Array.from(document.querySelectorAll('#tasksList > li')).map(li=>li.dataset.id);
      state.tasks.sort((a,b)=> ids.indexOf(a.id)-ids.indexOf(b.id));
      save();
    });
  });

      const txt = document.createElement('input');
      txt.type = 'text';
      txt.value = task.text;
      txt.className = 'flex-1 bg-transparent focus:outline-none';
      txt.addEventListener('input', () => { task.text = txt.value; save(); });

      if(task.done) txt.classList.add('tick-through');

      const meta = document.createElement('div');
      meta.className = 'flex items-center gap-2 text-xs text-slate-500';
      const est = document.createElement('input');
      est.type = 'number'; est.min = '0'; est.step = '1'; est.value = task.est||0; est.className='w-14 rounded-lg border border-slate-200 px-2 py-1';
      est.title = 'Estimated pomodoros';
      est.addEventListener('change', () => { task.est = Number(est.value)||0; save(); renderTasks(); });

      const badge = document.createElement('span');
      badge.className = 'px-2 py-0.5 rounded-full bg-slate-100';
      badge.textContent = `${task.poms||0} / ${task.est||0}`;

      const currentBtn = document.createElement('button');
      currentBtn.className = `px-2 py-1 rounded-xl ${task.current? 'bg-amber-100 text-amber-800':'bg-slate-100 text-slate-600'}`;
      currentBtn.textContent = task.current ? '● current' : '○ current';
      currentBtn.title = 'Mark as current task';
      currentBtn.addEventListener('click', () => {
        state.tasks.forEach(t=>t.current=false);
        task.current = true; save(); renderTasks();
      });

      const del = document.createElement('button');
      del.className = 'px-2 py-1 rounded-xl text-red-600 hover:bg-red-50';
      del.textContent = 'Delete';
      del.addEventListener('click', () => {
        state.tasks = state.tasks.filter(t=>t.id!==task.id);
        if(!state.tasks.some(t=>t.current) && state.tasks[0]) state.tasks[0].current = true;
        save(); renderTasks();
      });

      meta.append('Est:', est, badge, currentBtn, del);
      li.append(drag, checkbox, txt, meta);
      tasksList.append(li);

      // Drag & drop
      li.addEventListener('dragstart', e=>{ li.classList.add('dragging'); e.dataTransfer.setData('text/plain', task.id); });
      li.addEventListener('dragend', ()=> li.classList.remove('dragging'));
    });

    tasksList.addEventListener('dragover', e=>{
      e.preventDefault();
      const afterEl = getDragAfterElement(tasksList, e.clientY);
      const dragging = $('.dragging');
      if(!dragging) return;
      if(afterEl == null){ tasksList.appendChild(dragging); }
      else { tasksList.insertBefore(dragging, afterEl); }
    });

    tasksList.addEventListener('drop', ()=>{
      // Recompute order
      const ids = $$('#tasksList > li').map(li=>li.dataset.id);
      state.tasks.sort((a,b)=> ids.indexOf(a.id)-ids.indexOf(b.id));
      save();
    });
  }

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('li:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if(offset < 0 && offset > closest.offset){
        return { offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  taskForm.addEventListener('submit', e=>{
    e.preventDefault();
    const text = taskInput.value.trim();
    if(!text) return;
    addTask(text, estInput.value);
    taskForm.reset();
    taskInput.focus();
  });

  $('#clearDoneBtn').addEventListener('click', ()=>{
    state.tasks = state.tasks.filter(t=>!t.done);
    if(!state.tasks.some(t=>t.current) && state.tasks[0]) state.tasks[0].current = true;
    save(); renderTasks();
  });

  // ---------- Stats & Chart ----------
  const todayMinutesEl = $('#todayMinutes');
  const todaySessionsEl = $('#todaySessions');
  const streakDaysEl = $('#streakDays');
  let chart;

  function updateTodaySummary(){
    const k = todayKey();
    const t = state.stats[k] || { minutes: 0, focus: 0, short: 0, long: 0 };
    todayMinutesEl.textContent = t.minutes;
    todaySessionsEl.textContent = t.focus; // completed focus sessions today
    streakDaysEl.textContent = computeStreak();
  };
    todayMinutesEl.textContent = t.minutes;
    todaySessionsEl.textContent = t.sessions;
    streakDaysEl.textContent = computeStreak();
  }

  function computeStreak(){
    // Count consecutive days ending today with minutes > 0
    let streak = 0;
    const d = new Date();
    for(;;){
      const key = d.toISOString().slice(0,10);
      if(state.stats[key] && state.stats[key].minutes > 0){ streak++; d.setDate(d.getDate()-1); }
      else break;
    }
    return streak;
  }

  function renderChart(){
    const labels = [];
    const focusData = [];
    const shortData = [];
    const longData = [];
    const d = new Date();
    for(let i=13;i>=0;i--){
      const di = new Date(d); di.setDate(d.getDate()-i);
      const k = di.toISOString().slice(0,10);
      labels.push(k.slice(5)); // MM-DD
      const v = state.stats[k] || {};
      focusData.push(v.focus||0);
      shortData.push(v.short||0);
      longData.push(v.long||0);
    }
    const ctx = $('#statsChart').getContext('2d');
    if(chart){ chart.destroy(); }
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Focus', data: focusData, backgroundColor: '#ef4444', stack: 'sessions' },
          { label: 'Short break', data: shortData, backgroundColor: '#3b82f6', stack: 'sessions' },
          { label: 'Long break', data: longData, backgroundColor: '#10b981', stack: 'sessions' },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true },
          y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }
        },
        plugins: {
          legend: { display: true },
          tooltip: { callbacks: { label: (ctx)=> `${ctx.dataset.label}: ${ctx.parsed.y}` } }
        }
      }
    });
  }
    const ctx = $('#statsChart').getContext('2d');
    if(chart){ chart.destroy(); }
    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Focus minutes', data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 10 } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (ctx)=> `${ctx.parsed.y} min` } }
        }
      }
    });
  }

  // ---------- Settings ----------
  const settingsBtn = $('#settingsBtn');
  const settingsDialog = $('#settingsDialog');
  const setFocus = $('#setFocus');
  const setShort = $('#setShort');
  const setLong = $('#setLong');
  const setEvery = $('#setEvery');
  const setAutoStart = $('#setAutoStart');
  const setSound = $('#setSound');
  const setNotify = $('#setNotify');
  const resetAllBtn = $('#resetAllBtn');

  function openSettings(){
    setFocus.value = state.prefs.focusMin;
    setShort.value = state.prefs.shortMin;
    setLong.value = state.prefs.longMin;
    setEvery.value = state.prefs.longEvery;
    setAutoStart.checked = state.prefs.autoStartNext;
    setSound.checked = state.prefs.sound;
    setNotify.checked = state.prefs.notify;
    settingsDialog.showModal();
  }

  function applySettings(){
    state.prefs.focusMin = clamp(parseInt(setFocus.value)||DEFAULTS.focusMin, 1, 300);
    state.prefs.shortMin = clamp(parseInt(setShort.value)||DEFAULTS.shortMin, 1, 120);
    state.prefs.longMin = clamp(parseInt(setLong.value)||DEFAULTS.longMin, 1, 180);
    state.prefs.longEvery = clamp(parseInt(setEvery.value)||DEFAULTS.longEvery, 2, 12);
    state.prefs.autoStartNext = !!setAutoStart.checked;
    state.prefs.sound = !!setSound.checked;
    state.prefs.notify = !!setNotify.checked;
    save();
    // Update current mode duration
    state.remainingMs = durationFor(state.mode);
    renderTimer();
    updateModeTabs();
  }

  settingsBtn.addEventListener('click', openSettings);
  settingsDialog.addEventListener('close', applySettings);

  resetAllBtn.addEventListener('click', ()=>{
    if(confirm('Reset ALL local data (tasks, stats, preferences)?')){
      localStorage.removeItem(STORE_KEY);
      location.reload();
    }
  });

  // ---------- Export / Import ----------
  $('#exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `pomodoro-focus-${todayKey()}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  });

  $('#importInput').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const json = JSON.parse(reader.result);
        state = { ...state, ...json };
        state.prefs = { ...DEFAULTS, ...(json.prefs||{}) };
        save();
        setMode(state.mode||'focus');
        renderTasks();
        updateTodaySummary();
        renderChart();
        alert('Data imported.');
      }catch(err){ alert('Invalid JSON.'); }
    };
    reader.readAsText(file);
  });

  // ---------- Event wiring ----------
  startPauseBtn.addEventListener('click', ()=> state.running ? pause() : start());
  resetBtn.addEventListener('click', reset);
  skipBtn.addEventListener('click', onSessionComplete);
  $$('.modeTab').forEach(btn => btn.addEventListener('click', ()=> setMode(btn.dataset.mode)));

   state.running ? pause() : start(); }
    else if(e.key.toLowerCase() === 'r'){ reset(); }
    else if(e.key.toLowerCase() === 'n'){ onSessionComplete(); }
    else if(e.key === '1'){ setMode('focus'); }
    else if(e.key === '2'){ setMode('short'); }
    else if(e.key === '3'){ setMode('long'); }
  });

  $('#autoAdvanceTask').checked = !!state.tasks.find(t=>t.current);

  // ---------- Init ----------
  function init(){
    if(!state.sessionTotalMs){ state.sessionTotalMs = durationFor(state.mode); }
    // If returning with a running timer, recalc remaining
    if(state.running && state.endAt){
      const delta = state.endAt - Date.now();
      if(delta > 0){ state.remainingMs = delta; }
      else { state.running = false; state.remainingMs = 0; }
    }
    updateModeTabs();
    renderTimer();
    renderTasks();
    updateTodaySummary();
    renderChart();
    setInterval(tick, 250);
  }
  init();

  </script>
</body>
</html>
